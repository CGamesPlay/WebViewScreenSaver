<!DOCTYPE html>
<html>
<head>
<title>Screen Saver</title>
<script src="http://connect.facebook.net/en_US/all.js"></script>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<div id="fb-root"></div>
<div id="content"></div>
<script>

const PIC_SIZE = 180;
const INITIAL_DISTRIBUTION = 1;

var ALL_PHOTOS = [];
var CELLS = [];
var CELL_ROTATION_ORDER = [];
var ROWS = 0, COLS = 0;
var IS_SAVER_MODE = window.location.search.indexOf('saver') != -1;

var app_id = '274296999328339';
if (localStorage.getItem('app_id')) {
  app_id = localStorage.getItem('app_id');
}

FB.init({
  appId: app_id
});

FB.getLoginStatus(function(response) {
  if (response.status == 'connected') {
    startAnimation();
  } else {
    doLogin(startAnimation);
  }
});

function doLogin(then) {
  var content = document.getElementById('content');
  if (IS_SAVER_MODE) {
    // In screen saver mode
    content.innerHTML =
      '<div id="login-button">Open the options pane for instructions on setting up this screen saver.<br /><br /></div>';
    // Bug in webkit
    content.style.display = 'block';
  } else {
    // Access from browser
    content.innerHTML =
      '<div id="login-button">To use this screen saver, you must log in with Facebook.<br /><br />' +
      '<div class="fb-login-button" data-show-faces="false" data-width="200" data-max-rows="1"></div></div>';
    FB.XFBML.parse(content);
  }
  FB.Event.subscribe('auth.login', function() {
    then();
  });
}

function prefill() {
  for (var i = 0; i < CELLS.length; i++) {
    if (Math.random() < INITIAL_DISTRIBUTION) {
      (function (i) {
        var row = Math.floor(i / COLS);
        var col = i % COLS;
        setTimeout(function() {
          var photo = rotate(ALL_PHOTOS);
          switchCell(i, photo);
        }, 100 * (row + col));
      })(i);
    }
  }
}

function startAnimation() {
  buildGrid();
  window.onresize = function() {
    buildGrid();
    prefill();
  }


  getProfilePics(function(photos) {
    ALL_PHOTOS = photos;
    shuffle(ALL_PHOTOS);

    prefill();
    setTimeout(switchOne, 3000);
  });
}

function getProfilePics(then) {
  FB.api({
    method: 'fql.query',
    query: 'SELECT name, pic_big FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me())'
  }, function(data) {
    var result = [];
    for (var i = 0; i < data.length; i++) {
      result.push({
        url: data[i].pic_big,
        name: data[i].name
      });
    }
    then(result);
  });
}

function switchOne() {
  var cell = rotate(CELL_ROTATION_ORDER);
  var photo = rotate(ALL_PHOTOS);
  switchCell(cell, photo);

  var delay = Math.random() * 500 + 2000;
  setTimeout(switchOne, delay);
}

function shuffle(array) {
  for (var i = 0; i < array.length; i++) {
    var j = Math.floor(Math.random() * array.length);
    var temp = array[i];
    array[i] = array[j];
    array[j] = temp;
  }
}

function rotate(array) {
  var val = array.shift();
  array.push(val);
  return val;
}

function switchCell(i, photo) {
  var cell = CELLS[i];
  if (cell.childNodes.length > 0) {
    animateOut(cell.childNodes[0]);
  }
  var image = new Image();
  image.src = photo.url;
  image.addEventListener('load', function() {
    // This is a little clowny, but I need this here so that image gets closed
    // over this function.
    delete image;
    var div = document.createElement('div');
    cell.appendChild(div);
    div.setAttribute('class', 'picture');
    div.style.backgroundImage = 'url(' + photo.url + ')';
    animateIn(div);
    if (!IS_SAVER_MODE && photo.name) {
      // Adding this as an easter egg for the website only.
      var subtitle = document.createElement('div');
      subtitle.className = 'subtitle';
      subtitle.innerHTML = photo.name;
      div.appendChild(subtitle);
      subtitle.style.bottom = '-' + subtitle.clientHeight + 'px';
    }
  });
}

function animateOut(div) {
  div.setAttribute('class', 'picture leaving');
  div.addEventListener('webkitAnimationEnd', function() {
    div.parentElement.removeChild(div);
  });
}

function animateIn(div) {
}

function buildGrid() {
  COLS = Math.max(Math.ceil(window.innerWidth / PIC_SIZE), 4);
  ROWS = Math.max(Math.ceil(window.innerHeight / PIC_SIZE), 3);
  var content = document.getElementById('content');
  content.innerHTML = '';
  for (var y = 0; y < ROWS; y++) {
    var row = document.createElement('div');
    row.setAttribute('class', 'row');
    content.appendChild(row);
    for (var x = 0; x < COLS; x++) {
      var cell = document.createElement('div');
      row.appendChild(cell);
      CELLS.push(cell);
    }
  }

  CELL_ROTATION_ORDER = [];
  for (var i = 0; i < CELLS.length; i++) {
    CELL_ROTATION_ORDER.push(i);
  }
  shuffle(CELL_ROTATION_ORDER);
}
</script>
</body>
</html>
