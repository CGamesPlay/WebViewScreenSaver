<!DOCTYPE html>
<html manifest="saver.appcache">
<head>
<title>Screen Saver</title>
<script src="http://connect.facebook.net/en_US/all.js"></script>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<div id="fb-root"></div>
<div id="content"></div>
<script>

const PIC_SIZE = 180;

var ALL_PHOTOS = [];
var CELLS = [];
var CELL_ROTATION_ORDER = [];
var ROWS = 0, COLS = 0;
var PAGE_STARTED = new Date();
var IS_SAVER_MODE = window.location.search.indexOf('saver') != -1;
var mainAnimationStarted = false;

var app_id = '274296999328339';
if (localStorage.getItem('app_id')) {
  app_id = localStorage.getItem('app_id');
}

init();

function init() {
  try {
    FB.init({
      appId: app_id
    });

    FB.getLoginStatus(function(response) {
      if (response.status == 'connected') {
        didLogin();
      } else {
        tryLogin(didLogin);
      }
    });
  } catch(e) {
    // Connect might be unavailable. Hopefully we have a cache
  }

  buildGrid();
  window.onresize = function() {
    buildGrid();
    for (var i = 0; i < CELLS.length; i++) {
      if (CELLS[i].childNodes.length == 0) {
        switchCell(i, rotate(ALL_PHOTOS));
      }
    }
  }

  // If there is a cache, use it
  var cached = localStorage.getItem('photos_cache');
  if (cached) {
    ALL_PHOTOS = JSON.parse(cached);
    console.log('Loaded %d photos from cache', ALL_PHOTOS.length);
    startMainAnimation();
  }
}

function tryLogin(then) {
  var content = document.getElementById('content');
  if (IS_SAVER_MODE) {
    // In screen saver mode
    content.innerHTML =
      '<div id="login-button">Open the options pane for instructions on setting up this screen saver.<br /><br /></div>';
    // Bug in webkit
    content.style.display = 'block';
  } else {
    // Access from browser
    content.innerHTML =
      '<div id="login-button">To use this screen saver, you must log in with Facebook.<br /><br />' +
      '<div class="fb-login-button" data-show-faces="false" data-width="200" data-max-rows="1"></div></div>';
    FB.XFBML.parse(content);
  }
  FB.Event.subscribe('auth.login', function() {
    then();
  });
}

function didLogin() {
  getProfilePics(function(photos) {
    ALL_PHOTOS = photos;
    shuffle(ALL_PHOTOS);

    localStorage.setItem('photos_cache', JSON.stringify(photos));

    startMainAnimation();
  });
}

function getProfilePics(then) {
  FB.api({
    method: 'fql.query',
    query: 'SELECT name, pic_big FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me())'
  }, function(data) {
    var result = [];
    for (var i = 0; i < data.length; i++) {
      result.push({
        url: data[i].pic_big,
        name: data[i].name
      });
    }
    then(result);
  });
}

function startMainAnimation() {
  if (mainAnimationStarted) return;
  mainAnimationStarted = true;

  shuffle(ALL_PHOTOS);
  waterfall(mainAnimation);

  function mainAnimation() {
    var cell = rotate(CELL_ROTATION_ORDER);
    var photo = rotate(ALL_PHOTOS);
    switchCell(cell, photo);

    var delay = Math.random() * 500 + 2000;
    setTimeout(mainAnimation, delay);
  }
}

function waterfall(then) {
  var images = [];
  var waitingOn = 0, animationStarted = false;

  // Preload the images for the initial waterfall
  for (var i = 0; i < CELLS.length && i < ALL_PHOTOS.length; i++) {
    waitingOn++;
    var img = new Image();
    img.src = ALL_PHOTOS[i].url;
    images.push(img);
    img.addEventListener('load', function() {
      waitingOn--;
      if (waitingOn == 0) {
        startAnimation("Preloading finished");
      }
    });
  }
  console.log("Preloading %d photos", waitingOn);

  // But don't wait too long
  var deadline = PAGE_STARTED.getTime() + 4000;
  var delay = deadline - (new Date()).getTime();
  if (delay <= 0) {
    startAnimation("Not waiting due to lag");
  } else {
    setTimeout(function() {
      startAnimation("Prematurely starting animation");
    }, delay);
  }

  function startAnimation(reason) {
    if (animationStarted) return;
    animationStarted = true;
    if (reason) {
      console.log(reason);
    }

    for (var i = 0; i < CELLS.length; i++) {
      (function (i) {
        var row = Math.floor(i / COLS);
        var col = i % COLS;
        setTimeout(function() {
          var photo = rotate(ALL_PHOTOS);
          switchCell(i, photo);
        }, 100 * (row + col));
      })(i);
    }

    setTimeout(then, (ROWS + COLS) * 100 + 2000);
  }
}

function switchCell(i, photo) {
  var cell = CELLS[i];

  if (cell.dataset.loading) {
    return;
  }
  cell.dataset.loading = photo.url;

  var image = new Image();
  image.src = photo.url;
  image.addEventListener('load', function() {
    if (cell.childNodes.length > 0) {
      while (cell.childNodes.length > 1) {
        cell.removeChild(cell.childNodes[0]);
      }
      animateOut(cell.childNodes[0]);
    }

    delete cell.dataset.loading;

    var div = document.createElement('div');
    cell.appendChild(div);
    div.setAttribute('class', 'picture');
    div.style.backgroundImage = 'url(' + photo.url + ')';
    animateIn(div);
    if (!IS_SAVER_MODE && photo.name) {
      // Adding this as an easter egg for the website only.
      var subtitle = document.createElement('div');
      subtitle.className = 'subtitle';
      subtitle.innerHTML = photo.name;
      div.appendChild(subtitle);
      subtitle.style.bottom = '-' + subtitle.clientHeight + 'px';
    }
  });
}

function animateOut(div) {
  div.setAttribute('class', 'picture leaving');
  div.addEventListener('webkitAnimationEnd', function() {
    div.parentElement.removeChild(div);
  });
}

function animateIn(div) {
}

function buildGrid() {
  COLS = Math.max(Math.ceil(window.innerWidth / PIC_SIZE), 4);
  ROWS = Math.max(Math.ceil(window.innerHeight / PIC_SIZE), 3);
  var content = document.getElementById('content');

  if (ROWS == content.childNodes.length &&
      COLS == content.childNodes[0].childNodes.length) {
    return;
  }

  function buildRow(row) {
    // Add new cells
    for (var x = row.childNodes.length; x < COLS; x++) {
      row.appendChild(document.createElement('div'));
    }
    // Remove old cells
    for (var x = COLS; x < row.childNodes.length; x++) {
      row.removeChild(row.childNodes[row.childNodes.length - 1]);
    }
  }

  // Add new rows
  for (var y = content.childNodes.length; y < ROWS; y++) {
    var row = document.createElement('div');
    row.setAttribute('class', 'row');
    content.appendChild(row);
  }
  // Remove old rows
  for (var y = ROWS; y < content.childNodes.length; y++) {
    content.removeChild(content.childNodes[content.childNodes.length - 1]);
  }
  // Update all rows
  for (var y = 0; y < ROWS; y++) {
    var row = content.childNodes[y];
    buildRow(row);
  }

  // Recalculate all cells
  CELLS = [];
  for (var y = 0; y < content.childNodes.length; y++) {
    var row = content.childNodes[y];
    for (var x = 0; x < row.childNodes.length; x++) {
      CELLS.push(row.childNodes[x]);
    }
  }

  CELL_ROTATION_ORDER = [];
  for (var i = 0; i < CELLS.length; i++) {
    CELL_ROTATION_ORDER.push(i);
  }
  shuffle(CELL_ROTATION_ORDER);
}

function shuffle(array) {
  for (var i = 0; i < array.length; i++) {
    var j = Math.floor(Math.random() * array.length);
    var temp = array[i];
    array[i] = array[j];
    array[j] = temp;
  }
}

function rotate(array) {
  var val = array.shift();
  array.push(val);
  return val;
}

</script>
</body>
</html>
